# 构建最终镜像
FROM php:8.2.27-cli-bookworm

# 安装常用扩展
RUN apt-get update && apt-get install -y --no-install-recommends \
   procps vim tzdata make unzip libpq-dev libzip-dev libpng-dev libmagickwand-dev zlib1g-dev \
   && ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
   && dpkg-reconfigure -f noninteractive tzdata \
   && docker-php-ext-install pdo_pgsql bcmath gd zip sockets pcntl \
   && pecl install imagick igbinary msgpack\
   && docker-php-ext-enable imagick igbinary msgpack pcntl \
   && apt-get clean \
   && rm -rf /var/lib/apt/lists/* \
   && rm -rf /tmp/pear \
   && docker-php-source delete

# minio客户端
COPY docker/main/mc /usr/local/bin/mc
RUN chmod +x /usr/local/bin/mc

# 添加自定义加密扩展
COPY docker/main/edl.so /usr/local/lib/php/extensions/no-debug-non-zts-20220829/
RUN docker-php-ext-enable edl

WORKDIR /var/www/
COPY . .

# 安装php依赖
COPY php/composer.lock php/composer.lock
RUN COMPOSER_ALLOW_SUPERUSER=1 composer --working-dir php install --no-dev

# 复制环境变量文件
COPY .env.prod .env

# 权限
RUN chmod -R 777 php/runtime

# 运行
RUN chmod +x /var/www/golang/build/master
CMD ["/var/www/golang/build/master"]
